# Flow Sight API仕様書（リニューアル版）

## 1. 概要

Flow Sightは個人の金融管理を行うためのWebアプリケーションです。クレジットカードやローンの支払い管理、月次キャッシュフロー予測、収入・支出の管理を通じて、健全な資金管理をサポートします。

本仕様書では、リニューアルに向けて必要なAPI機能とその目的を定義します。

## 2. システムアーキテクチャ

### 2.1. 技術スタック
- バックエンド: Go 1.24.5, OpenAPI, PostgreSQL
- インフラ: Docker, Kubernetes, Helm

## 3. API機能仕様

### 3.1. 資産管理API（Assets Management）

#### 目的
ユーザーが所有するクレジットカードやローンなどの金融資産を管理し、支払いスケジュールの基準となる情報を保持します。

#### 必要な理由
- 各カードの締め日・支払日が異なるため、正確なキャッシュフロー計算に必要
- 複数のカードやローンを一元管理することで、支払い忘れを防止
- 銀行口座との紐づけにより、どの口座から引き落とされるかを明確化

#### 主要機能
- **資産登録**: 新しいクレジットカードやローンの基本情報を登録
- **資産一覧取得**: 登録済みの全資産を表示
- **資産情報更新**: 支払日や銀行口座の変更など
- **資産削除**: 解約したカードやローンの削除

#### データ項目
- 資産名（例：メインクレジットカード、住宅ローン）
- 資産タイプ（カード/ローン）
- 締め日（クレジットカードの場合）
- 支払日
- 引き落とし銀行口座
- 作成・更新日時

### 3.2. 銀行口座管理API（Bank Accounts Management）

#### 目的
ユーザーの銀行口座情報を管理し、キャッシュフロー計算の基準残高を提供します。

#### 必要な理由
- キャッシュフロー予測の開始残高として必要
- どの口座から何が引き落とされるかを把握するため
- 複数口座の残高を一元管理することで全体の資金状況を把握

#### 主要機能
- **口座登録**: 新しい銀行口座の登録
- **口座一覧取得**: 保有する全銀行口座の表示
- **残高更新**: 口座残高の手動更新
- **口座削除**: 解約した口座の削除

#### データ項目
- 口座名（例：メイン口座、貯蓄口座）
- 現在残高
- 作成・更新日時

### 3.3. 収入管理API（Income Management）

#### 目的
ユーザーの収入源と実際の収入実績を管理し、キャッシュフロー予測に反映します。

#### 必要な理由
- 月次キャッシュフロー予測において収入を正確に計算するため
- 給与、ボーナス、副業など複数の収入源を管理するため
- 実績と予定の差異を把握し、より精密な予測を行うため

#### 主要機能
- **収入源マスター管理**: 継続的な収入源（給与など）の登録・更新・削除
- **月次収入実績管理**: 特定月の実際の収入額の登録・更新・削除

#### データ項目（収入源マスター）
- 収入源名（例：本業給与、副業、投資収益）
- 収入タイプ（月次固定/単発）
- 基本金額
- 振込先銀行口座
- 入金予定年月（単発収入の場合）
- 有効/無効フラグ

#### データ項目（月次収入実績）
- 対象収入源
- 対象年月
- 実際の収入額
- 確定フラグ
- メモ

### 3.4. 固定支出管理API（Recurring Payments Management）

#### 目的
家賃、保険料、ローン返済など毎月発生する固定支出を管理し、キャッシュフロー予測に反映します。

#### 必要な理由
- 毎月確実に発生する支出を自動的にキャッシュフロー計算に含めるため
- 支払い忘れを防止するため
- 総支払い回数が決まっているローンなどの残回数を管理するため

#### 主要機能
- **固定支出登録**: 新しい固定支出の登録
- **固定支出一覧取得**: 登録済みの全固定支出の表示
- **固定支出更新**: 金額や支払日の変更
- **固定支出削除**: 終了した支払いの削除

#### データ項目
- 支出名（例：住宅ローン、家賃、保険料）
- 支払金額
- 支払日
- 支払開始月
- 総支払回数（ローンの場合）
- 残り支払回数
- 引き落とし銀行口座
- 有効/無効フラグ
- 備考

### 3.5. カード月次利用額管理API（Card Monthly Totals Management）

#### 目的
クレジットカードの月次利用総額を管理し、締め日・支払日を考慮した正確な支払いスケジュールを作成します。

#### 必要な理由
- カードの利用額が月によって変動するため、実際の利用額を記録する必要
- 締め日と支払日の関係を正確に反映するため（例：15日締め翌月10日払い）
- 分割払いやリボ払いの管理のため

#### 主要機能
- **月次利用額登録**: 特定カードの特定月の利用総額を登録
- **月次利用額一覧取得**: カード別・月別の利用額を表示
- **月次利用額更新**: 利用額の修正
- **月次利用額削除**: 誤った記録の削除

#### データ項目
- 対象カード（資産マスターと紐づけ）
- 対象年月
- 利用総額
- 確定フラグ（明細が確定したかどうか）
- 作成・更新日時

### 3.6. キャッシュフロー予測API（Cashflow Projection）

#### 目的
登録された全ての情報を統合し、将来の資金残高推移を予測して表示します。

#### 必要な理由
- 将来的な資金不足を事前に把握するため
- 大きな支出や収入の影響を可視化するため
- 資金計画の立案をサポートするため

#### 主要機能
- **キャッシュフロー予測計算**: 指定期間の日次残高推移を計算
- **予測結果取得**: 計算結果をグラフ表示用データとして提供

#### 計算ロジック
1. 銀行口座の初期残高から開始
2. 各日において以下を計算：
   - 収入（給料日に基づく）
   - 固定支出（支払日に基づく）
   - カード支払い（締め日・支払日を考慮）
3. 日次残高 = 前日残高 + 収入 - 支出

#### データ項目
- 対象日付
- 収入額
- 支出額
- 日次残高
- 主要な入出金項目の詳細

### 3.7. アプリケーション設定API（App Settings）

#### 目的
アプリケーション全体の動作を制御する設定値を管理します。

#### 必要な理由
- キャッシュフロー予測の表示期間などユーザー固有の設定を保存するため
- 最低限の月次支出額などの基準値を設定するため

#### 主要機能
- **設定値取得**: 現在の設定値を取得
- **設定値更新**: 設定値の変更

#### データ項目
- 最低月次支出額（キャッシュフロー予測用の基準値）
- 表示期間設定
- その他アプリケーション設定

## 4. データ連携とビジネスロジック

### 4.1. 締め日・支払日の計算
クレジットカードの利用額は、締め日と支払日の関係を正確に反映する必要があります：
- 例：15日締め翌月10日払いの場合
  - 1月16日〜2月15日の利用分 → 3月10日に支払い
  - この計算ロジックをキャッシュフロー予測に組み込む

### 4.2. 分割払い・リボ払いの処理
将来的には分割払いやリボ払いの詳細管理も想定されるため、拡張可能な設計とします。

### 4.3. 複数銀行口座の残高統合
複数の銀行口座を持つ場合、全体の資金状況を把握するための統合計算が必要です。

## 5. セキュリティとデータ保護

### 5.1. 個人金融情報の保護
- 金額などの機密情報は適切に暗号化して保存
- アクセスログの記録と監視

### 5.2. 認証・認可
- ユーザー認証機能の実装
- 個人データへの不正アクセス防止

## 6. 今後の拡張予定

### 6.1. 支出詳細管理
現在は月次総額のみですが、将来的には個別の支出記録も管理予定

### 6.2. 予算管理機能
月次・年次の予算設定と実績との比較機能

### 6.3. レポート機能
- 月次・年次の収支サマリー
- カテゴリ別支出分析
- 支出トレンド分析

### 6.4. 外部連携
- 銀行口座のAPI連携
- クレジットカード明細の自動取得

## 7. パフォーマンス要件

### 7.1. レスポンス時間
- 一般的なCRUD操作：500ms以内
- キャッシュフロー予測計算：2秒以内

### 7.2. データ処理能力
- 36ヶ月分のキャッシュフロー予測を高速に計算
- 複数カード・複数口座の同時処理

## 8. エラーハンドリング

### 8.1. バリデーション
- 日付の妥当性チェック
- 金額の範囲チェック
- 必須項目の入力チェック

### 8.2. エラーレスポンス
- 明確なエラーメッセージ
- エラーコードの統一
- フロントエンド向けの適切なHTTPステータスコード

